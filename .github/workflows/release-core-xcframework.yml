name: Release Core XCFramework

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0 without v prefix)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Build and Release
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26'

      - name: Grant execute permission for scripts
        run: |
          find scripts -type f -name "*.sh" -exec chmod +x {} \;
          chmod +x gradlew

      - name: Set version variables
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG_NAME="v${VERSION}"

          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ Version: $VERSION"
          echo "ğŸ“‹ Tag: $TAG_NAME"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Invalid version format. Expected: X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Build XCFramework and calculate checksum
        id: build
        run: |
          ./scripts/release/create-release.sh ${{ steps.version.outputs.version }}

          # Read the checksum
          CHECKSUM=$(cat build/releases/${{ steps.version.outputs.version }}/checksum.txt)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "âœ… Checksum: $CHECKSUM"

      - name: Update and commit Package.swift
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag }}"
          CHECKSUM="${{ steps.build.outputs.checksum }}"

          # Update Package.swift with the correct URL and checksum
          sed -i.bak \
            -e "s|url: \"https://github.com/snooky23/spectra/releases/download/v.*\.xcframework\.zip\"|url: \"https://github.com/snooky23/spectra/releases/download/v${VERSION}/SpectraLogger.xcframework.zip\"|" \
            -e "s|checksum: \".*\"|checksum: \"${CHECKSUM}\"|" \
            Package.swift

          rm Package.swift.bak

          echo "âœ… Updated Package.swift"
          cat Package.swift

          # Commit changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Package.swift
          git commit -m "chore: update Package.swift for v${VERSION}" \
            -m "Updated XCFramework URL and checksum for release v${VERSION}" \
            -m "Checksum: ${CHECKSUM}"

          echo "âœ… Package.swift committed"

      - name: Create and push tag
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          CHECKSUM="${{ steps.build.outputs.checksum }}"

          # Create annotated tag with multi-line message
          git tag -a "$TAG_NAME" \
            -m "Release ${VERSION} - Production-ready logging framework" \
            -m "" \
            -m "ğŸš€ SpectraLogger v${VERSION}" \
            -m "" \
            -m "## Core Framework" \
            -m "- High-performance logging with < 0.1ms capture time" \
            -m "- Network request/response interception" \
            -m "- Thread-safe operations" \
            -m "- Cross-platform (iOS 13.0+ & Android 7.0+)" \
            -m "" \
            -m "## Installation" \
            -m "See release notes for Swift Package Manager and CocoaPods instructions." \
            -m "" \
            -m "Checksum: ${CHECKSUM}"

          # Push commit and tag
          git push origin main
          git push origin "$TAG_NAME"

          echo "âœ… Tag $TAG_NAME created and pushed"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag }}"
          ZIP_PATH="build/releases/${VERSION}/SpectraLogger.xcframework.zip"
          CHECKSUM="${{ steps.build.outputs.checksum }}"

          # Create release notes using heredoc
          cat > release_notes.md << EOF
          Release ${VERSION} - Production-ready logging framework

          ## What's Included

          ### Core Framework (SpectraLogger)
          - High-performance logging with < 0.1ms capture time
          - Network request/response interception
          - Circular buffer storage with automatic pruning
          - Thread-safe operations for multi-threaded apps
          - Cross-platform support (iOS 13.0+ & Android 7.0+)

          ### iOS UI Companion (SpectraLoggerUI)
          - Native SwiftUI log viewer
          - Real-time log streaming
          - Advanced filtering and search
          - Network traffic inspector
          - Export capabilities (JSON, Text, CSV)

          ## Installation

          ### Swift Package Manager

          Add to your \`Package.swift\`:

          \`\`\`swift
          dependencies: [
              .package(url: "https://github.com/snooky23/spectra.git", from: "${VERSION}")
          ]
          \`\`\`

          Or use the binary target directly:

          \`\`\`swift
          .binaryTarget(
              name: "SpectraLogger",
              url: "https://github.com/snooky23/spectra/releases/download/v${VERSION}/SpectraLogger.xcframework.zip",
              checksum: "${CHECKSUM}"
          )
          \`\`\`

          ### CocoaPods
          \`\`\`ruby
          pod 'SpectraLogger', '~> ${VERSION}'
          pod 'SpectraLoggerUI', '~> ${VERSION}'  # Optional: SwiftUI UI
          \`\`\`

          ## Verification

          XCFramework SHA256 checksum:
          \`\`\`
          ${CHECKSUM}
          \`\`\`

          ## Documentation
          - [Installation Guide](https://github.com/snooky23/spectra/blob/main/docs/INSTALLATION.md)
          - [CocoaPods Guide](https://github.com/snooky23/spectra/blob/main/docs/COCOAPODS_GUIDE.md)
          - [SPM Distribution Guide](https://github.com/snooky23/spectra/blob/main/docs/SPM_DISTRIBUTION_GUIDE.md)

          ğŸ‰ Ready for production use!
          EOF

          gh release create "${TAG_NAME}" \
            "$ZIP_PATH" \
            --title "Release ${VERSION}" \
            --notes-file release_notes.md

      - name: Publish to CocoaPods
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          # Check if CocoaPods token is set
          if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
            echo "â­ï¸  Skipping CocoaPods publishing (no COCOAPODS_TRUNK_TOKEN secret set)"
            exit 0
          fi

          echo "ğŸ“¦ Publishing to CocoaPods..."

          # Verify file exists
          if [ ! -f "spectra-core/SpectraLogger.podspec" ]; then
            echo "âŒ Error: spectra-core/SpectraLogger.podspec not found!"
            ls -la spectra-core/
            exit 1
          fi

          echo "ğŸ” Before update:"
          grep -E "(s\.version|:sha256)" spectra-core/SpectraLogger.podspec

          # Update podspec version and checksum
          CHECKSUM="${{ steps.build.outputs.checksum }}"
          echo "ğŸ” Updating with checksum: $CHECKSUM"

          # Use perl with explicit in-place editing
          perl -i.backup -pe "s/s\.version\s*=\s*'[^']*'/s.version = '${{ steps.version.outputs.version }}'/" spectra-core/SpectraLogger.podspec
          perl -i.backup -pe "s/:sha256\s*=>\s*'[^']*'/:sha256 => '${CHECKSUM}'/" spectra-core/SpectraLogger.podspec

          # Remove backup files
          rm -f spectra-core/SpectraLogger.podspec.backup

          echo "ğŸ” After update:"
          grep -E "(s\.version|:sha256)" spectra-core/SpectraLogger.podspec

          # Publish to CocoaPods
          cd shared
          echo "ğŸ” About to push podspec from $(pwd):"
          grep -E "(s\.version|:sha256)" SpectraLogger.podspec
          pod trunk push SpectraLogger.podspec --allow-warnings

          echo "âœ… Published to CocoaPods successfully!"

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Release v${{ steps.version.outputs.version }} completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Release URL: https://github.com/snooky23/spectra/releases/tag/v${{ steps.version.outputs.version }}"
          echo "ğŸ“‹ Checksum: ${{ steps.build.outputs.checksum }}"
          echo ""
          echo "âœ… Completed:"
          echo "  1. Built XCFramework for all iOS targets"
          echo "  2. Created GitHub Release with binary"
          echo "  3. Generated installation instructions"
          if [ -n "${{ secrets.COCOAPODS_TRUNK_TOKEN }}" ]; then
            echo "  4. Published to CocoaPods"
          else
            echo "  4. â­ï¸  CocoaPods publishing skipped (no token set)"
          fi
          echo ""
          echo "ğŸ“ Installation instructions are in the release notes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
