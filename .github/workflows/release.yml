name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write  # Required for creating releases

jobs:
  release:
    name: Create Release
    runs-on: macos-15  # Use macOS 15 (Sequoia) for best Apple Silicon support

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Extract version from tag
        id: get_version
        run: |
          # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: $VERSION"

      - name: Grant execute permission for scripts
        run: |
          chmod +x scripts/build/*.sh
          chmod +x scripts/release/*.sh

      - name: Build XCFramework
        run: ./scripts/build/build-xcframework.sh Release

      - name: Package XCFramework with checksum
        id: package
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          FRAMEWORK_NAME="SpectraLogger"
          XCFRAMEWORK_PATH="build/xcframework/$FRAMEWORK_NAME.xcframework"
          ZIP_NAME="$FRAMEWORK_NAME.xcframework.zip"

          # Create zip
          cd build/xcframework
          zip -r "$ZIP_NAME" "$FRAMEWORK_NAME.xcframework"
          cd ../..

          # Calculate checksum
          CHECKSUM=$(swift package compute-checksum "build/xcframework/$ZIP_NAME")
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "ZIP_PATH=build/xcframework/$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_OUTPUT

          echo "âœ… Package created"
          echo "ğŸ“¦ File: $ZIP_NAME"
          echo "ğŸ” Checksum: $CHECKSUM"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          CHECKSUM="${{ steps.package.outputs.CHECKSUM }}"
          ZIP_NAME="${{ steps.package.outputs.ZIP_NAME }}"

          cat > release-notes.md << 'EOFNOTES'
          # SpectraLogger vVERSION_PLACEHOLDER ğŸš€

          **Production-ready lightweight logging framework for iOS and Android**

          ## ğŸ“¦ What's Included

          ### Core Framework (SpectraLogger)
          - âš¡ **Ultra-fast logging**: < 0.1ms capture time (99th percentile < 1ms)
          - ğŸŒ **Network interception**: Automatic HTTP/HTTPS request/response logging
          - ğŸ’¾ **Smart storage**: Circular buffer with automatic pruning (< 50MB for 10K+ logs)
          - ğŸ”’ **Thread-safe**: Optimized for multi-threaded mobile apps
          - ğŸ“± **Cross-platform**: iOS 13.0+ and Android 7.0+ (API 24+)
          - ğŸª¶ **Lightweight**: Only 8.5MB

          ### iOS UI Companion (SpectraLoggerUI)
          - ğŸ¨ **Native SwiftUI**: Beautiful, native iOS interface
          - ğŸ“Š **Real-time streaming**: Smooth 60 FPS log scrolling
          - ğŸ” **Advanced filtering**: Multi-level filters, search, time ranges
          - ğŸŒ **Network inspector**: JSON syntax highlighting, cURL export
          - ğŸ“¤ **Export**: JSON, Text, CSV formats with AirDrop support

          ---

          ## ğŸ“¥ Installation

          ### Swift Package Manager (Recommended)

          Add to your Xcode project:
          ```
          https://github.com/REPO_PLACEHOLDER.git
          ```

          Or in `Package.swift`:
          ```swift
          dependencies: [
              .package(url: "https://github.com/REPO_PLACEHOLDER.git", from: "VERSION_PLACEHOLDER")
          ]
          ```

          ### CocoaPods

          Add to your `Podfile`:
          ```ruby
          pod 'SpectraLogger', '~> VERSION_PLACEHOLDER'           # Core logging
          pod 'SpectraLoggerUI', '~> VERSION_PLACEHOLDER'         # Optional: SwiftUI UI
          ```

          Then run:
          ```bash
          pod install
          ```

          ### Carthage

          Add to your `Cartfile`:
          ```ruby
          binary "https://raw.githubusercontent.com/REPO_PLACEHOLDER/main/SpectraLogger.json" ~> VERSION_PLACEHOLDER
          ```

          Then run:
          ```bash
          carthage update --use-xcframeworks --platform iOS
          ```

          ---

          ## ğŸš€ Quick Start

          ### Initialize Logger
          ```swift
          import SpectraLogger

          // In AppDelegate or App struct
          SpectraLogger.configure(
              maxInMemoryLogs: 1000,
              enableFileLogging: true,
              enableNetworkLogging: true
          )
          ```

          ### Log Messages
          ```swift
          let logger = SpectraLogger.getLogger(category: "MyFeature")

          logger.info("User logged in")
          logger.debug("Processing data...")
          logger.error("Operation failed", error: error)
          ```

          ### Show UI (iOS with SpectraLoggerUI)
          ```swift
          import SwiftUI
          import SpectraLoggerUI

          struct ContentView: View {
              @State private var showLogs = false

              var body: some View {
                  Button("Show Logs") {
                      showLogs = true
                  }
                  .sheet(isPresented: $showLogs) {
                      SpectraLoggerView()
                  }
              }
          }
          ```

          ---

          ## ğŸ“Š Technical Specifications

          | Component | Size | Platforms | Language |
          |-----------|------|-----------|----------|
          | **SpectraLogger** | 8.5MB | iOS 13.0+, Android 7.0+ | Kotlin Multiplatform |
          | **SpectraLoggerUI** | Source | iOS 15.0+ | Swift/SwiftUI |

          ### Binary Target Information (for manual SPM setup)

          ```swift
          .binaryTarget(
              name: "SpectraLogger",
              url: "https://github.com/REPO_PLACEHOLDER/releases/download/vVERSION_PLACEHOLDER/ZIP_NAME_PLACEHOLDER",
              checksum: "CHECKSUM_PLACEHOLDER"
          )
          ```

          **SHA256 Checksum:** `CHECKSUM_PLACEHOLDER`

          ### License
          Apache 2.0 (commercial-friendly)

          ---

          ## ğŸ“š Documentation

          - [Installation Guide](https://github.com/REPO_PLACEHOLDER/blob/main/docs/INSTALLATION.md)
          - [CocoaPods Guide](https://github.com/REPO_PLACEHOLDER/blob/main/docs/COCOAPODS_GUIDE.md)
          - [Carthage Guide](https://github.com/REPO_PLACEHOLDER/blob/main/docs/CARTHAGE_GUIDE.md)
          - [SPM Distribution](https://github.com/REPO_PLACEHOLDER/blob/main/docs/SPM_DISTRIBUTION_GUIDE.md)
          - [Architecture Overview](https://github.com/REPO_PLACEHOLDER/blob/main/ARCHITECTURE.md)

          ---

          **Happy logging! ğŸ“**
          EOFNOTES

          # Replace placeholders
          sed -i '' "s/VERSION_PLACEHOLDER/$VERSION/g" release-notes.md
          sed -i '' "s/CHECKSUM_PLACEHOLDER/$CHECKSUM/g" release-notes.md
          sed -i '' "s/ZIP_NAME_PLACEHOLDER/$ZIP_NAME/g" release-notes.md
          sed -i '' "s|REPO_PLACEHOLDER|${{ github.repository }}|g" release-notes.md

          echo "RELEASE_NOTES_PATH=release-notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.package.outputs.ZIP_PATH }}
          body_path: ${{ steps.release_notes.outputs.RELEASE_NOTES_PATH }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print release summary
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          CHECKSUM="${{ steps.package.outputs.CHECKSUM }}"
          ZIP_NAME="${{ steps.package.outputs.ZIP_NAME }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Release created successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ“ File: $ZIP_NAME"
          echo "ğŸ” Checksum: $CHECKSUM"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âš ï¸  Next steps:"
          echo "1. Update Package.swift with the URL and checksum above"
          echo "2. Commit and push the Package.swift changes"
          echo "3. Announce the release!"

      # Publish to CocoaPods (skipped - podspec files not set up yet)
      # To enable: create spectra-core/SpectraLogger.podspec and spectra-ui-ios/SpectraLoggerUI.podspec
      # - name: Publish to CocoaPods Trunk
      #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      #   env:
      #     COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      #   run: |
      #     echo "CocoaPods publishing disabled - podspec files not configured"

      # Publish to Maven Central
      - name: Publish to Maven Central
        run: ./gradlew :spectra-core:publishAllPublicationsToMavenCentralRepository
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.SIGNING_PASSWORD }}

